# This file was generated by Chef
# Do NOT modify this file by hand.

<% if @use_ssl and node['route53']['hosted_zone_exists'] %>
server {
    listen 80;
    server_name <%= @domain %> www.<%= @domain %>;
    return 301 https://$host$request_uri;
}
<% end %>

server {
<% if @use_ssl and node['route53']['hosted_zone_exists'] %>
    listen 443 ssl;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_ciphers 'AES256+EECDH:AES256+EDH';
    ssl_certificate     /etc/nginx/ssl/<%= @domain %>.chained.crt;
    ssl_certificate_key /etc/nginx/ssl/<%= @domain %>.key;
<% else %>
    listen 80;
<% end %>

    server_name <%= @domain %> www.<%= @domain %>;

    root <%= node['nginx']['root_dir'] %>;

    location / {
        if (-f $request_filename/index.php) {
            break;
        }
        try_files $uri $uri/index.html /index.php$is_args$args;
    }

    location ~ ^/_debugbar {
        rewrite .* /index.php;
    }

    location /admin {
        auth_basic           "closed site";
        auth_basic_user_file htpasswd;
    }

    # caching of static files
    location ~* \.(js|css|png|jpg|jpeg|gif|swf|xml|txt|ico|pdf|flv)$ {
        access_log off;
        log_not_found off;
        expires max;
    }

    location ~ \.php$ {
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
        include        /etc/nginx/fastcgi_params;
        fastcgi_param  ENVIRONMENT          production;
        fastcgi_param  HTTP_REFERER         $http_referer;
        fastcgi_param  SCRIPT_FILENAME      $document_root$fastcgi_script_name;
        fastcgi_param  HTTP_X_FORWARDED_FOR $http_x_forwarded_for;
        fastcgi_pass_header Set-Cookie;
        fastcgi_pass_header Cookie;
    }
}
